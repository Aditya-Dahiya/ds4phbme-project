---
title: "Final Project (SG/VB/AD)"
output: 
  flexdashboard::flex_dashboard:
    theme: united
    css: styles.css
runtime: shiny
---

```{r}
# Loading libraries
library(tidyverse)
library(here)
library(lubridate)
library(latex2exp)
library(sf)
library(maps)
library(rgeos)
library(rnaturalearth)
library(plotly)
library(shinyWidgets)
library(shiny)

##################### Global Data Sets Loading ##########################

# Loading the wrangled data sets
load(here("data", "wrangled", "Annual_Data_PM2-5_Sites.rda"))
load(here("data", "wrangled", "Daily_Data_10years.rda"))

# Plotting the Annual Average Data on PM 2.5 on USA map

USmap = ne_countries(country = "united states of america",
                     scale = "medium",
                     returnclass = "sf")
USstates = spData::us_states

UScounties = sf::st_as_sf(
    maps::map("county", 
              plot = FALSE,
              fill = TRUE))
AnnData = AnnData %>%
            mutate(xloc = - 110, 
                   yloc = 27)

# Creating subsets using User Inputs for the Shiny App
List_States = unique(AnnData$`State Name`)[1:50] %>% sort()

# Creating some data frames for maps' plotting
UScounties = sf::st_as_sf(maps::map("county", 
                                    plot = FALSE,
                                    fill = TRUE))
temp = str_split(string = UScounties$ID, 
                 pattern = ",", 
                 simplify = TRUE,
                 n = 2) %>%
    as_tibble() %>%
    mutate(State = str_to_title(V1)) %>%
    mutate(County = str_to_title(V2)) %>%
    select(State, County)
UScounties = bind_cols(UScounties, temp)
rm(temp)

CompleteListCounty = unique(DlyData$`County Name`) %>% sort()

```



Overview
===================================== 
    
Column
-------------------------------------
    
### USA: Historical trends in PM 2.5 levels

```{r, echo=FALSE}
knitr::include_graphics(path = "./gganim1995-2020.gif")
```

### Average level of PM 2.5 in EPA monitoing stations over years

```{r}
knitr::include_graphics(path = "./g1lineplot.gif")
```


Column
-------------------------------------


### Project Overview

Authors:  

1. Sejal Ghate (BME student, Whiting School)  

2. Vinayak Bhardwaj (MPH student, Bloomberg School)  

3. Aditya Dahiya (MPH student, Bloomberg School)  

This project focuses on the [Air Data](https://www.epa.gov/outdoor-air-quality-data): Air Quality Data Collected at Outdoor Monitors Across the United States. It uses and combines data from three sources:-  

(a) Outdoor air quality [data](https://aqs.epa.gov/aqsweb/documents/data_api.html) collected from state, local and tribal monitoring agencies across the United States by the [EPA](https://www.epa.gov/).  

(b) Data harvested from the Air Quality System (AQS) API using the R package [aqrs](https://github.com/jpkeller/aqsr), developed by [Joshua P. Keller](https://github.com/jpkeller), [Roger D. Peng](https://github.com/rdpeng) and [Daniel Bride](https://github.com/danielbride).  

(c) A special [data set](https://raw.githubusercontent.com/opencasestudies/ocs-bp-air-pollution/master/data/raw/pm25_data.csv) created by [Roger D. Peng](https://github.com/rdpeng), used by Open Case Studies project on predicting PM 2.5 levels using machine learning algorithms in [tidymodels](https://www.tidymodels.org/).  
\
\

The **Visualization** tab shows different visualizations of $PM_{2.5}$ levels in ${\mu}g/m^{3}$ over time periods, states, sites and seasons. Then, **Data Analysis** tab analyzes Roger D. Peng's [dataset](https://raw.githubusercontent.com/opencasestudies/ocs-bp-air-pollution/master/data/raw/pm25_data.csv) and displays important predictors. Fianlly, the **Prediction** tab uses machine learning algorithms to predict $PM_{2.5}$ levels and find best predictor variables.

```{r}

```

Visualizations
===================================== 
    
Inputs {.sidebar}
-------------------------------------
Shiny app inputs 
```{r}
# shiny inputs defined here
pickerInput(
   inputId = "Sel_State",
   label = "Select State", 
   choices = List_States,
   selected = List_States[5]
)

sliderInput(inputId = "Sel_Year", 
            label = "Select year to display", 
            min = 1995, 
            max = 2020, 
            value = 2015)


```
 
Column
-------------------------------------
    
### Air Quality Monitoring Sites: Mean Annual PM 2.5 levels
    
```{r}
renderPlotly({

Sel_State = input$Sel_State
Sel_Year = input$Sel_Year
ggplotly(
    ggplot(data = USmap) +
    geom_sf(data = USstates, 
            fill = NA, 
            color = "grey",
            alpha = 0.5) +
    coord_sf(xlim = c(-125, -66), ylim = c(24.5, 50), 
             expand = FALSE) +
    ggthemes::theme_map() + 
    geom_point(data = AnnData[AnnData$Year == Sel_Year, ],
               mapping = aes(x = Longitude, 
                             y = Latitude,
                             col = MeanPM2.5,
                             text = `County Name`,
                             text1 = `City Name`),
               size = 0.7,
               alpha = 0.5,
               pch = 20) +
    geom_text(data = AnnData[AnnData$Year == Sel_Year, ], 
              aes(y = yloc, x = xloc, 
                  label = as.character(Year)), 
              check_overlap = TRUE, 
              size = 5, 
              fontface="bold") + 
    scale_color_gradientn(colours = topo.colors(7), 
                          na.value = "transparent",
                          breaks = c(0, 5, 10, 15),
                          labels = c(0, 5, 10, 15),
                          limits = c(0, 20), 
                          name = "PM 2.5 (ug/m3)"),
    tooltip = c("text", "text1", "MeanPM2.5")
    )
})
```
    
### Location of selected State on map of USA

```{r}
renderPlot({
  
    Sel_State = input$Sel_State

    USstates %>%
    mutate(FillVar = ifelse(NAME == Sel_State,
                            yes = 1, 
                            no = 0)) %>%
    ggplot() +
    geom_sf(aes(fill = as.factor(FillVar)), 
            color = "black",
            alpha = 0.5) +
    coord_sf(xlim = c(-125, -66), ylim = c(24.5, 50), 
             expand = FALSE) +
    theme_void() +
    scale_fill_manual(values = c("0" = "white", "1" = "red")) +
    theme(legend.position = "none")
  
  
})

```


Column
-------------------------------------
    
### Monitoring Sites in selected State: Mean Annual PM 2.5 levels
    
```{r}
renderPlotly({

  Sel_State = input$Sel_State
  Sel_Year = input$Sel_Year

  ggplotly(
    UScounties %>%            
        filter(State == Sel_State) %>%
        ggplot() +
        geom_sf(fill = NA, 
                color = "grey",
                alpha = 0.5) +
        ggthemes::theme_map() + 
        geom_point(data = AnnData[(AnnData$Year == Sel_Year &
                                       AnnData$`State Name` == Sel_State), ],
                   mapping = aes(x = Longitude, 
                                 y = Latitude,
                                 col = MeanPM2.5,
                                 text = `County Name`,
                                 text1 = `City Name`),
                   size = 1.5,
                   alpha = 0.5,
                   pch = 20) +
        scale_color_gradientn(colours = topo.colors(7), 
                              na.value = "transparent",
                              breaks = c(0, 5, 10, 15),
                              labels = c(0, 5, 10, 15),
                              limits = c(0, 20), 
                              name = "PM 2.5 (ug/m3)"),
    tooltip = c("text", "text1", "MeanPM2.5")
  )

})

```


### State-wise Mean PM 2.5 level trends (1995 - 2020)


```{r}
renderPlot({
  
  Sel_State = input$Sel_State
  Sel_Year = input$Sel_Year
  
  AnnData %>%
    group_by(`State Name`, Year) %>%
    summarize(MMPM2.5 = mean(MeanPM2.5)) %>%
    mutate(ColState = ifelse(`State Name` == Sel_State, 1, 0.2)) %>%
    mutate(ColState = as.factor(ColState)) %>%
    
    ggplot(aes(x = Year, y = MMPM2.5)) +
    geom_line(aes(col = ColState,
                  group = `State Name`,
                  alpha = ColState),
              lwd = 1) +
    scale_y_continuous(limits = c(4, 16)) +
    scale_color_manual(values = c("darkgrey", "black"),
                       name = "States",
                       labels = c("Other States", Sel_State)) +
    theme_classic() +
    theme(legend.position = "bottom") +
    labs(y = "Mean Annual PM 2.5 levels (ug/m3)",
         x = NULL) +
    guides(alpha = FALSE)
  
  
})
```  



Data Analysis
=====================================     

Inputs {.sidebar}
-------------------------------------
Shiny app inputs 
```{r}

selectInput(inputId = "Sel_State", 
            label = "Select a state", 
            choices = List_States,
            selected = List_States[5],
            multiple = FALSE)

selectInput(inputId = "Sel_County", 
            label = "Select Counties", 
            choices = CompleteListCounty,
            multiple = TRUE)


sliderInput(inputId = "Sel_Year", 
            label = "Select year to display", 
            min = 1995, 
            max = 2020, 
            value = c(2014, 2019))



```


### Chart 1
    
```{r}
```
    
### Chart 2

```{r}
```

Prediction
=====================================     

```{r echo=FALSE,warning=FALSE,message=FALSE}

selectizeInput("Education level",label=h3("Select the required countries"),
            choices=c('Italy','India','Brazil','Spain'),selected='India',multiple=T)

selectInput("Age",label=h3("Select the required Scale"),
            choices=c('Raw Scale','Natural Log'))

radioButtons('County',label=h3('Do you want a smoothed time series?'),choices=c('Yes','No'))

radioButtons('Category of pollutants',label=h3('Select data'),choices=c('Total cases','Deaths','Recoveries'))

radioButtons('Population density',label=h3('Plot from:'),choices=c('Time from calender date','Time since first case'), selected = 'Time from calender date')

dateRangeInput("dates", label = h3("Date range"),format = "mm-dd-yyyy", start = "2021-01-01",
               end = "2021-03-20")


```


About
=====================================    

Column {data-width=850}
-------------------------------------
    
### Citations and Credits  

1. [Flexdashboard](https://rmarkdown.rstudio.com/flexdashboard/index.html) for R-Markdown  

2. [Shiny](https://shiny.rstudio.com/) from R Studio  

3. R package [aqsr](https://github.com/jpkeller/aqsr) for data downloading from EPA's API  

4. United States Environment Protection Agency (EPA): [Air Quality System (AQS) API](https://aqs.epa.gov/aqsweb/documents/data_api.html)  

5. United States EPA: Pre-Generated [Data Files](https://aqs.epa.gov/aqsweb/airdata/download_files.html)  

6. [Geocomputation with R](https://geocompr.robinlovelace.net/): Lovelace, Nowosad & Muenchow  

7. R package [gganimate](https://gganimate.com/index.html) by Thomas Lin Pedersen & David Robinson

8. R packages: `tidyverse`, `aqsr`, `tidymodels`, `here`, `lubridate`, `latex2exp`, `sf`, `maps`, `rgeos`, `rnaturalearth`, `plotly`, `corrplot`, `GGally`, `vip`, `ggthemes`.

```{r}

```
   
Column {data-width=150}
-------------------------------------
   
### Sejal Ghate  

Sejal's photo here

```{r}

```   
 
### Vinayak Bhardwaj  

Vinayak's photo here

```{r}

```

### Aditya Dahiya  

```{r}
knitr::include_graphics(path = "./Aditya.jpg")
```
