---
title: "Final Project (SG/VB/AD)"
output: 
  flexdashboard::flex_dashboard:
    theme: united
    css: styles.css
runtime: shiny
---

```{r}
# Loading libraries
library(tidyverse)
library(lubridate)
library(latex2exp)
library(sf)
library(maps)
library(rgeos)
library(rnaturalearth)
library(plotly)
library(shinyWidgets)
library(shiny)
library(RColorBrewer)
library(rnaturalearthdata)
##################### Global Data Sets Loading ##########################

# Loading the wrangled data sets
load(url("https://raw.githubusercontent.com/Aditya-Dahiya/ds4phbme-project/main/data/wrangled/Annual_Data_PM2-5_Sites.rda"))

# Plotting the Annual Average Data on PM 2.5 on USA map

USmap = ne_countries(country = "united states of america",
                     scale = "medium",
                     returnclass = "sf")
USstates = spData::us_states

UScounties = sf::st_as_sf(
    maps::map("county", 
              plot = FALSE,
              fill = TRUE))
AnnData = AnnData %>%
            mutate(xloc = - 110, 
                   yloc = 27)

# Creating subsets using User Inputs for the Shiny App
List_States = unique(AnnData$`State Name`)[1:50] %>% sort()

# Creating some data frames for maps' plotting
UScounties = sf::st_as_sf(maps::map("county", 
                                    plot = FALSE,
                                    fill = TRUE))
temp = str_split(string = UScounties$ID, 
                 pattern = ",", 
                 simplify = TRUE,
                 n = 2) %>%
    as_tibble() %>%
    mutate(State = str_to_title(V1)) %>%
    mutate(County = str_to_title(V2)) %>%
    select(State, County)
UScounties = bind_cols(UScounties, temp)
rm(temp)


```



Overview
===================================== 
    
Column
-------------------------------------
    
### USA: Historical trends in PM 2.5 levels

```{r, echo=FALSE}
knitr::include_graphics(path = "https://raw.githubusercontent.com/Aditya-Dahiya/ds4phbme-project/main/gganim1995-2020.gif")
```

### Average level of PM 2.5 in EPA monitoing stations over years

```{r}
knitr::include_graphics(path = "https://raw.githubusercontent.com/Aditya-Dahiya/ds4phbme-project/main/g1lineplot.gif")
```


Column
-------------------------------------


### Project Overview


**US EPA Air Pollution Data (PM 2.5): Data Visualization, Analysis and Prediction**

Authors:  

1. Sejal Ghate (BME student, Whiting School)  

2. Vinayak Bhardwaj (MPH student, Bloomberg School)  

3. Aditya Dahiya (MPH student, Bloomberg School)  

This project focuses on the [Air Data](https://www.epa.gov/outdoor-air-quality-data): Air Quality Data Collected at Outdoor Monitors Across the United States. It uses and combines data from three sources:-  

(a) Outdoor air quality [data](https://aqs.epa.gov/aqsweb/documents/data_api.html) collected from state, local and tribal monitoring agencies across the United States by the [EPA](https://www.epa.gov/).  

(b) Data harvested from the Air Quality System (AQS) API using the R package [aqrs](https://github.com/jpkeller/aqsr), developed by [Joshua P. Keller](https://github.com/jpkeller), [Roger D. Peng](https://github.com/rdpeng) and [Daniel Bride](https://github.com/danielbride).  

(c) A special [data set](https://raw.githubusercontent.com/opencasestudies/ocs-bp-air-pollution/master/data/raw/pm25_data.csv) created by [Roger D. Peng](https://github.com/rdpeng), used by Open Case Studies project on predicting PM 2.5 levels using machine learning algorithms in [tidymodels](https://www.tidymodels.org/).  

**Tabs in the app**:  

- The **Visualization** tab shows different visualizations of $PM_{2.5}$ levels in ${\mu}g/m^{3}$ over time periods, states, sites and seasons.  
- Then, **Data Analysis** tab adds important graphs to analyze month-wise, year-wise and smoothed trens of PM 2.5 levels in various counties selected by the user. It also allows one to examine data in cities within the selected counties.  
- Finally, the **Prediction** tab analyzes Roger D. Peng's [dataset](https://raw.githubusercontent.com/opencasestudies/ocs-bp-air-pollution/master/data/raw/pm25_data.csv) and displays important predictors. It then uses machine learning algorithms to predict $PM_{2.5}$ levels and find best predictor variables.  


Visualizations
===================================== 
    
Inputs {.sidebar}
-------------------------------------

The [EPA](https://www.epa.gov/) collects [Air Quality data](https://www.epa.gov/outdoor-air-quality-data) from Outdoor Monitor sites across the US. This page harvests data from EPA's API [webpage](https://aqs.epa.gov/aqsweb/documents/data_api.html), and displays the outdoor monitors' location and their average annual PM 2.5 levels.  

**Select the state and year to update the maps**  

```{r}
# shiny inputs defined here
pickerInput(
   inputId = "Sel_State",
   label = "Select State", 
   choices = List_States,
   selected = List_States[5]
)

sliderInput(inputId = "Sel_Year", 
            label = "Select year to display", 
            min = 1995, 
            max = 2020, 
            value = 2015)

```


Column
-------------------------------------
    
### Air Quality Monitoring Sites: Mean Annual PM 2.5 levels
    
```{r}
renderPlotly({

Sel_State = input$Sel_State
Sel_Year = input$Sel_Year
ggplotly(
    ggplot(data = USmap) +
    geom_sf(data = USstates, 
            fill = NA, 
            color = "grey",
            alpha = 0.5) +
    coord_sf(xlim = c(-125, -66), ylim = c(24.5, 50), 
             expand = FALSE) +
    ggthemes::theme_map() + 
    geom_point(data = AnnData[AnnData$Year == Sel_Year, ],
               mapping = aes(x = Longitude, 
                             y = Latitude,
                             col = MeanPM2.5,
                             text = `County Name`,
                             text1 = `City Name`),
               size = 0.7,
               alpha = 0.5,
               pch = 20) +
    geom_text(data = AnnData[AnnData$Year == Sel_Year, ], 
              aes(y = yloc, x = xloc, 
                  label = as.character(Year)), 
              check_overlap = TRUE, 
              size = 5, 
              fontface="bold") + 
    scale_color_gradientn(colours = topo.colors(7), 
                          na.value = "transparent",
                          breaks = c(0, 5, 10, 15),
                          labels = c(0, 5, 10, 15),
                          limits = c(0, 20), 
                          name = "PM 2.5 (ug/m3)"),
    tooltip = c("text", "text1", "MeanPM2.5")
    )
})
```
    
### Maximum PM 2.5 levels (ug/m3) recorded at each site during the year

```{r}
renderPlotly({

Sel_State = input$Sel_State
Sel_Year = input$Sel_Year
ggplotly(
    ggplot(data = USmap) +
    geom_sf(data = USstates, 
            fill = NA, 
            color = "grey",
            alpha = 0.5) +
    coord_sf(xlim = c(-125, -66), ylim = c(24.5, 50), 
             expand = FALSE) +
    ggthemes::theme_map() + 
    geom_point(data = AnnData[AnnData$Year == Sel_Year, ],
               mapping = aes(x = Longitude, 
                             y = Latitude,
                             col = MaxPM2.5,
                             text = `County Name`,
                             text1 = `City Name`),
               size = 0.7,
               alpha = 0.5,
               pch = 20) +
    geom_text(data = AnnData[AnnData$Year == Sel_Year, ], 
              aes(y = yloc, x = xloc, 
                  label = as.character(Year)), 
              check_overlap = TRUE, 
              size = 5, 
              fontface="bold") + 
    scale_color_gradientn(colours = rev(heat.colors(10)), 
                          na.value = "transparent",
                          breaks = c(0, 25, 50, 75),
                          labels = c(0, 25, 50, 75),
                          limits = c(0, 100), 
                          name = "PM 2.5 (ug/m3)"),
    tooltip = c("text", "text1", "MaxPM2.5")
    )
})

```


Column
-------------------------------------
    
### Monitoring Sites in selected State: Mean Annual PM 2.5 levels
    
```{r}
renderPlotly({

  Sel_State = input$Sel_State
  Sel_Year = input$Sel_Year

  ggplotly(
    UScounties %>%            
        filter(State == Sel_State) %>%
        ggplot() +
        geom_sf(fill = NA, 
                color = "grey",
                alpha = 0.5) +
        ggthemes::theme_map() + 
        geom_point(data = AnnData[(AnnData$Year == Sel_Year &
                                       AnnData$`State Name` == Sel_State), ],
                   mapping = aes(x = Longitude, 
                                 y = Latitude,
                                 col = MeanPM2.5,
                                 text = `County Name`,
                                 text1 = `City Name`),
                   size = 1.5,
                   alpha = 0.5,
                   pch = 20) +
        scale_color_gradientn(colours = topo.colors(7), 
                              na.value = "transparent",
                              breaks = c(0, 5, 10, 15),
                              labels = c(0, 5, 10, 15),
                              limits = c(0, 20), 
                              name = "PM 2.5 (ug/m3)"),
    tooltip = c("text", "text1", "MeanPM2.5")
  )

})

```


### State-wise Mean PM 2.5 level trends (1995 - 2020): Selected state highlighted


```{r}
renderPlot({
  
  Sel_State = input$Sel_State
  Sel_Year = input$Sel_Year
  
  AnnData %>%
    group_by(`State Name`, Year) %>%
    summarize(MMPM2.5 = mean(MeanPM2.5)) %>%
    mutate(ColState = ifelse(`State Name` == Sel_State, 1, 0.2)) %>%
    mutate(ColState = as.factor(ColState)) %>%
    
    ggplot(aes(x = Year, y = MMPM2.5)) +
    geom_line(aes(col = ColState,
                  group = `State Name`,
                  alpha = ColState),
              lwd = 1) +
    scale_y_continuous(limits = c(4, 16)) +
    scale_color_manual(values = c("darkgrey", "black"),
                       name = "States",
                       labels = c("Other States", Sel_State)) +
    theme_classic() +
    theme(legend.position = "bottom") +
    labs(y = "Mean Annual PM 2.5 levels (ug/m3)",
         x = NULL) +
    guides(alpha = FALSE)
  
  
})
```  


Data Analysis
=====================================     

```{r global}
library(tidyverse)
library(shiny)

# Loading the daily PM 2.5 and AQI data set

load(url("https://raw.githubusercontent.com/Aditya-Dahiya/ds4phbme-project/main/data/wrangled/Daily_Data_10years.rda"))

load(url("https://raw.githubusercontent.com/Aditya-Dahiya/ds4phbme-project/main/data/wrangled/List_of_States_Counties_Cities.rda"))


# Creating subsets using User Inputs for the Shiny App
List_States = unique(ListDlyData$`State Name`)[1:50]

```

Column {.sidebar}
-----------------------------------------------------------------------

This page pulls data off the EPA's [API webpage](https://aqs.epa.gov/aqsweb/documents/data_api.html) to display analytic trends of PM 2.5 (in ${\mu}g / m^{3}$) across different Counties selected by the user.  

**Note: Kindly wait for a few moments till the page loads data from the web.**  

```{r}
selectInput(inputId = "Sel_State1", 
            label = "Select a state :",
            choices = List_States,
            selected = List_States[5])

List_Counties = reactive({
  unique(ListDlyData[ListDlyData$`State Name` %in% input$Sel_State1, ]$`County Name`) %>% 
    sort()
})

renderUI({
selectInput(inputId = "Sel_County1", 
            label = "Select Counties to analyse:",
            choices = List_Counties(),
            selected = List_Counties()[c(12, 13)],
            multiple = TRUE)
  })

List_Cities = reactive({
  unique(ListDlyData[ListDlyData$`County Name` %in% input$Sel_County1, ]$`City Name`) %>% 
    sort()
})

renderUI({
selectInput(inputId = "Sel_City1", 
            label = "Select Cities within these Counties:",
            choices = List_Cities(),
            selected = List_Cities()[1:length(List_Cities())],
            multiple = TRUE)
  })

Plotdata = reactive({
        DlyData %>%
        filter(`State Name` %in% input$Sel_State1,
               `County Name` %in% input$Sel_County1) %>%
        mutate(Month = lubridate::month(Date,
                                        label = TRUE)) %>%
        mutate(Year = lubridate::year(Date))
  })

```

**Note:** This page extracts data previously scraped and stored in GitHub to ensure quicker response time. Detailed data extraction is in this [R Script](https://github.com/Aditya-Dahiya/ds4phbme-project/blob/main/EPA%20Datasets%20Fetch%20AQSR.R).



Column 
-----------------------------------------------------------------------

### Chart 1 - Plot of daily PM 2.5 levels, with an overlaid smoothing line

```{r}

renderPlot({
    
    Plotdata4 = Plotdata()
    
    ggplot(data = Plotdata4, aes(x = Date, y = PM2.5)) + 
        geom_smooth(aes(y = PM2.5, 
                            col = `County Name`),
                            se = FALSE) +
        geom_point(aes(col = `County Name`),
                   alpha = 0.1,
                   pch = 20) + 
        scale_y_continuous(limits = c(0,
                                      quantile(Plotdata4$PM2.5, 0.9))) + 
        theme_classic() + 
        theme(legend.position = "bottom") +
        labs(x = NULL, 
             y = latex2exp::TeX("PM_{2.5} \ \ levels \ \ (ug / m^{3})")
        )
    
})

```


### Average PM 2.5 levels in different Cities within these Counties

```{r}
renderPlot({
  
  Plotdata1 = Plotdata()
  
  ggplot(Plotdata1, aes(x = Date)) + 
    geom_smooth(aes(y = PM2.5, 
                    col = `City Name`),
                    se = FALSE) +
    theme_classic() + 
    theme(legend.position = "bottom") +
    labs(x = NULL,
         y = latex2exp::TeX("PM_{2.5} \ \ levels \ \ (ug / m^{3})"))
  
})


```


Column 
-----------------------------------------------------------------------

### Average monthly PM 2.5 levels 

```{r}
renderPlot({
  
  Plotdata2 = Plotdata()
  
  ggplot(data = Plotdata2) +
    geom_boxplot(mapping = aes(x = Month, 
                               y = PM2.5,
                               col = `County Name`),
                 outlier.size = 1,
                 outlier.alpha = 0.1) +
    scale_y_continuous(limits = c(0, 
                                  quantile(Plotdata2$PM2.5, 0.99))) +
    theme_classic() +
    theme(legend.position = "bottom") +
    labs(x = NULL, 
         y = latex2exp::TeX("PM_{2.5} \ \ levels \ \ (ug / m^{3})"))

})
```
    
### Annual Average PM 2.5 Levels (ug/m3)

```{r}
renderPlot({
  
  Plotdata3 = Plotdata()
  
  ggplot(data = Plotdata3) +
    geom_boxplot(mapping = aes(x = as.factor(Year), 
                               y = PM2.5,
                               col = `County Name`),
                 outlier.size = 1,
                 outlier.alpha = 0.1) +
    scale_y_continuous(limits = c(0, 
                                  quantile(Plotdata3$PM2.5, 0.99))) +
    theme_classic() +
    theme(legend.position = "bottom") +
    labs(x = NULL, 
         y = latex2exp::TeX("PM_{2.5} \ \ levels \ \ (ug / m^{3})"))
  
})
```





Prediction
=====================================     

```{r echo=FALSE,warning=FALSE,message=FALSE}

selectizeInput("Education level",label=h3("Select the required countries"),
            choices=c('Italy','India','Brazil','Spain'),selected='India',multiple=T)

selectInput("Age",label=h3("Select the required Scale"),
            choices=c('Raw Scale','Natural Log'))

radioButtons('County',label=h3('Do you want a smoothed time series?'),choices=c('Yes','No'))

radioButtons('Category of pollutants',label=h3('Select data'),choices=c('Total cases','Deaths','Recoveries'))

radioButtons('Population density',label=h3('Plot from:'),choices=c('Time from calender date','Time since first case'), selected = 'Time from calender date')

dateRangeInput("dates", label = h3("Date range"),format = "mm-dd-yyyy", start = "2021-01-01",
               end = "2021-03-20")


```


About
=====================================  


```{r}

```
   

Column {data-width=850}
-------------------------------------
    
    
    
### Citations and Credits  

1. [Flexdashboard](https://rmarkdown.rstudio.com/flexdashboard/index.html) for R-Markdown  

2. [Shiny](https://shiny.rstudio.com/) from R Studio  

3. R package [aqsr](https://github.com/jpkeller/aqsr) for data downloading from EPA's API  

4. United States Environment Protection Agency (EPA): [Air Quality System (AQS) API](https://aqs.epa.gov/aqsweb/documents/data_api.html)  

5. United States EPA: Pre-Generated [Data Files](https://aqs.epa.gov/aqsweb/airdata/download_files.html)  

6. [Geocomputation with R](https://geocompr.robinlovelace.net/): Lovelace, Nowosad & Muenchow  

7. R package [gganimate](https://gganimate.com/index.html) by Thomas Lin Pedersen & David Robinson

8. R packages: `tidyverse`, `aqsr`, `tidymodels`, `here`, `lubridate`, `latex2exp`, `sf`, `maps`, `rgeos`, `rnaturalearth`, `plotly`, `corrplot`, `GGally`, `vip`, `ggthemes`.

9. The animated graphs on **Overview** page were created using package `gganimate`, the source code is attached [here](https://raw.githubusercontent.com/Aditya-Dahiya/ds4phbme-project/main/g1lineplot.gif).

```{r}

```
   
Column {data-width=150}
-------------------------------------
   
### Sejal Ghate  

```{r}
knitr::include_graphics(path = "https://raw.githubusercontent.com/Aditya-Dahiya/ds4phbme-project/main/sejal.jpeg")
```   
 
### Vinayak Bhardwaj  


```{r}
knitr::include_graphics(path = "https://github.com/Aditya-Dahiya/ds4phbme-project/blob/main/Vinayak.jpg?raw=true")

```

### Aditya Dahiya  

```{r}
knitr::include_graphics(path = "https://raw.githubusercontent.com/Aditya-Dahiya/ds4phbme-project/main/Aditya.jpg")
```
